{% extends 'base.html' %}
{% load static %}

{% block title %}Attendance System - Task Manager{% endblock %}

{% block content %}
<div class="attendance-container">

    <!-- Page Header -->
    <div class="page-header">
        <div class="header-content">
            <h1>Attendance Management</h1>
            <p class="page-subtitle">Mark daily attendance for all users</p>
        </div>
        <div class="header-stats">
            <div class="stat-badge">
                <span class="badge-label">Total Users</span>
                <span class="badge-value">1</span>
            </div>
            <div class="stat-badge stat-present">
                <span class="badge-label">Present</span>
                <span class="badge-value" id="presentCount">0</span>
            </div>
            <div class="stat-badge stat-absent">
                <span class="badge-label">Absent</span>
                <span class="badge-value" id="absentCount">0</span>
            </div>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-btn active" onclick="switchTab('mark')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 11l3 3L22 4"></path>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            Mark Attendance
        </button>
        <button class="tab-btn" onclick="switchTab('history')">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            Attendance History
        </button>
    </div>

    <!-- Mark Attendance Tab -->
    <div id="markTab" class="tab-content active">

        <!-- Attendance List Section -->
        <div class="attendance-list-section">
            <div class="list-card">
                
                <!-- List Card Header -->
                <div class="list-card-header">
                    <div class="list-title">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <h2>User Attendance (1)</h2>
                    </div>
                    <div class="list-search">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" id="searchUser" placeholder="Search users..." class="search-input" onkeyup="filterUsers()">
                    </div>
                </div>

                <!-- Attendance List -->
                <div class="attendance-list" id="attendanceList">

                    {% if user %}
                    <div class="attendance-item"
                         data-user-id="{{ user.id }}"
                         data-user-name="{{ user.username }}">

                        <div class="user-info">
                            <div class="user-avatar">
                                <span>{{ user.username|slice:": 1"|upper }}</span>
                            </div>
                            <div class="user-details">
                                <h4 class="user-name">{{ user.username }}</h4>
                                <p class="user-email">{{ user.email|default:"No email" }}</p>
                            </div>
                        </div>

                        <div class="attendance-status" id="status-{{ user.id }}">
                            <span class="status-label">Not Marked</span>
                        </div>

                        <div class="attendance-actions">
                            <button
                                type="button"
                                class="btn-attendance btn-present"
                                data-user-id="{{ user.id }}"
                                data-user-name="{{ user.username }}"
                                onclick="handleAttendanceClick(this, 'present')">
                                Present
                            </button>

                            <button
                                type="button"
                                class="btn-attendance btn-absent"
                                data-user-id="{{ user.id }}"
                                data-user-name="{{ user.username }}"
                                onclick="handleAttendanceClick(this, 'absent')">
                                Absent
                            </button>
                        </div>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1. 5">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                        </svg>
                        <h3>No Users Found</h3>
                        <p>There are no users to mark attendance for</p>
                    </div>
                    {% endif %}

                </div>

                <!-- List Footer -->
                <div class="list-footer">
                    <div class="footer-info">
                        <span id="markedCount">0</span> of <span>1</span> marked
                    </div>
                    <button class="btn btn-primary btn-submit" id="submitBtn" onclick="submitAttendance()">
                        Submit Attendance
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Attendance History Tab -->
    <div id="historyTab" class="tab-content">
        <!-- Filters -->
        <div class="history-filters">
            <div class="filter-card">
                <div class="filter-group">
                    <label for="filterDate" class="filter-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        Filter by Date
                    </label>
                    <input type="date" id="filterDate" class="form-input" onchange="filterHistory()">
                </div>
                <div class="filter-group">
                    <label for="filterStatus" class="filter-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                        </svg>
                        Filter by Status
                    </label>
                    <select id="filterStatus" class="form-input" onchange="filterHistory()">
                        <option value="all">All Status</option>
                        <option value="present">Present</option>
                        <option value="absent">Absent</option>
                    </select>
                </div>
                <button class="btn-filter-reset" onclick="resetFilters()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="1 4 1 10 7 10"></polyline>
                        <polyline points="23 20 23 14 17 14"></polyline>
                        <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
                    </svg>
                    Reset
                </button>
            </div>
        </div>

        <!-- History List -->
        <div class="history-section">
            <div class="history-card">
                <div class="history-header">
                    <h3>Attendance Records</h3>
                    <div class="history-stats">
                        <span class="history-stat">
                            <strong id="totalRecords">{{ attendance_list|length }}</strong> Total Records
                        </span>
                    </div>
                </div>

                <div class="history-table-container" id="historyList">
                    {% if attendance_list %}
                        {% for date, day_data in attendance_list.items %}
                            {% for inner_date, data in day_data.items %}

                            <div class="history-date-block" data-date="{{ date }}">
                                <!-- Date Header -->
                                <div class="history-date-header">
                                    <div class="date-info">
                                        <div class="date-badge-inline">
                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                                <line x1="3" y1="10" x2="21" y2="10"></line>
                                            </svg>
                                            <span class="date-text">{{ date }}</span>
                                        </div>
                                    </div>
                                    <div class="date-actions">
                                        <button class="btn-icon-small" onclick='downloadRecord("{{ date }}", {{ data|safe }})' title="Download CSV">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                <polyline points="7 10 12 15 17 10"></polyline>
                                                <line x1="12" y1="15" x2="12" y2="3"></line>
                                            </svg>
                                        </button>
                                        <button class="btn-icon-small btn-delete-small" onclick="deleteRecord('{{ date }}')" title="Delete">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="3 6 5 6 21 6"></polyline>
                                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>

                                <!-- Attendance Table -->
                                {% if data.AttendanceData %}
                                <div class="table-responsive">
                                    <table class="attendance-history-table">
                                        <thead>
                                            <tr>
                                                <th>#</th>
                                                <th>User Name</th>
                                                <th>Status</th>
                                                <th>Time</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for record in data.AttendanceData %}
                                            <tr data-status="{{ record.status }}">
                                                <td>{{ forloop.counter }}</td>
                                                <td>
                                                    <div class="table-user">
                                                        <div class="table-user-avatar">{{ record.name|slice:":1"|upper }}</div>
                                                        <span class="table-user-name">{{ record.name }}</span>
                                                    </div>
                                                </td>
                                                <td>
                                                    {% if record.status == 'present' %}
                                                    <span class="table-status-badge status-present">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <polyline points="20 6 9 17 4 12"></polyline>
                                                        </svg>
                                                        Present
                                                    </span>
                                                    {% else %}
                                                    <span class="table-status-badge status-absent">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                                        </svg>
                                                        Absent
                                                    </span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <span class="table-time">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <circle cx="12" cy="12" r="10"></circle>
                                                            <polyline points="12 6 12 12 16 14"></polyline>
                                                        </svg>
                                                        {{ record.submitted_time }}
                                                    </span>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Summary -->
                                <div class="table-summary">
                                    <div class="summary-item">
                                        <span class="summary-label">Total: </span>
                                        <span class="summary-value">{{ data.AttendanceData|length }}</span>
                                    </div>
                                    <div class="summary-item summary-present">
                                        <span class="summary-label">Present:</span>
                                        <span class="summary-value" data-present-count="{{ forloop.counter }}">0</span>
                                    </div>
                                    <div class="summary-item summary-absent">
                                        <span class="summary-label">Absent:</span>
                                        <span class="summary-value" data-absent-count="{{ forloop.counter }}">0</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        {% endfor %}
                    {% else %}
                    <div class="empty-state">
                        <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <h3>No Attendance Records</h3>
                        <p>Start marking attendance to see records here</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>

<form style="display: none;">{% csrf_token %}</form>

<script>
/* ================================
   ATTENDANCE MANAGEMENT (TABLE VIEW)
================================ */

let attendanceData = {};
let currentTab = 'mark';

/* Init */
document.addEventListener('DOMContentLoaded', () => {
    updateCounts();
    calculateTableSummary();
});

/* Tab Switching */
function switchTab(tab) {
    currentTab = tab;
    
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.closest('.tab-btn').classList.add('active');
    
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    if (tab === 'mark') {
        document.getElementById('markTab').classList.add('active');
    } else {
        document.getElementById('historyTab').classList.add('active');
    }
}

/* Click handler */
function handleAttendanceClick(btn, status) {
    const userId = btn.dataset.userId;
    const userName = btn.dataset. userName;
    markAttendance(userId, userName, status);
}

/* Core logic */
function markAttendance(userId, userName, status) {
    const now = new Date();
    const submittedTime = now.toTimeString().split(' ')[0];
    
    attendanceData[userId] = {
        name: userName,
        status: status,
        submitted_time: submittedTime
    };

    const statusEl = document.getElementById(`status-${userId}`);
    const item = document.querySelector(`.attendance-item[data-user-id="${userId}"]`);

    if (! item || !statusEl) return;

    item.classList.remove('marked-present', 'marked-absent');

    if (status === 'present') {
        statusEl.innerHTML = `<span class="status-label status-present">✓ Present (${submittedTime})</span>`;
        item.classList.add('marked-present');
    } else {
        statusEl.innerHTML = `<span class="status-label status-absent">✗ Absent (${submittedTime})</span>`;
        item.classList.add('marked-absent');
    }

    updateCounts();
}

/* Counters */
function updateCounts() {
    let present = 0;
    let absent = 0;

    Object.values(attendanceData).forEach(r => {
        if (r. status === 'present') present++;
        if (r.status === 'absent') absent++;
    });

    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = absent;
    document.getElementById('markedCount').textContent = present + absent;
}

/* Calculate table summary */
function calculateTableSummary() {
    document.querySelectorAll('.history-date-block').forEach((block) => {
        const rows = block.querySelectorAll('tbody tr');
        let presentCount = 0;
        let absentCount = 0;
        
        rows.forEach(row => {
            const status = row.dataset.status;
            if (status === 'present') presentCount++;
            if (status === 'absent') absentCount++;
        });
        
        const presentEl = block.querySelector('[data-present-count]');
        const absentEl = block. querySelector('[data-absent-count]');
        
        if (presentEl) presentEl.textContent = presentCount;
        if (absentEl) absentEl.textContent = absentCount;
    });
}

/* Search filter */
function filterUsers() {
    const searchTerm = document.getElementById('searchUser').value.toLowerCase();

    document.querySelectorAll('.attendance-item').forEach(item => {
        const userName = item.getAttribute('data-user-name').toLowerCase();
        item.style.display = userName.includes(searchTerm) ? '' : 'none';
    });
}

/* Submit */
function submitAttendance() {
    if (Object.keys(attendanceData).length === 0) {
        alert('Please mark attendance');
        return;
    }

    const today = new Date().toISOString().split('T')[0];
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    const payload = {
        [today]: {
            AttendanceData: Object.values(attendanceData)
        }
    };

    // Get userid from the URL path
    const userid = window.location.pathname.split('/')[2];
    const url = `/attendance_submit/${userid}/`;

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify(payload)
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            resetAttendance();
            window.location.reload();
        } else {
            alert(data.message || 'Submission failed');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Server error');
    });
}

/* Reset */
function resetAttendance() {
    attendanceData = {};
    document. querySelectorAll('.attendance-status').forEach(el => {
        el.innerHTML = '<span class="status-label">Not Marked</span>';
    });
    document.querySelectorAll('.attendance-item').forEach(el => {
        el.classList. remove('marked-present', 'marked-absent');
    });
    document.getElementById('searchUser').value = '';
    updateCounts();
}

/* History Functions */
function filterHistory() {
    const filterDate = document.getElementById('filterDate').value;
    const filterStatus = document.getElementById('filterStatus').value;
    
    document.querySelectorAll('.history-date-block').forEach(block => {
        const blockDate = block.dataset.date;
        let showBlock = true;
        
        if (filterDate && blockDate !== filterDate) {
            showBlock = false;
        }
        
        if (filterStatus !== 'all') {
            const rows = block.querySelectorAll('tbody tr');
            let hasStatus = false;
            rows.forEach(row => {
                if (row.dataset.status === filterStatus) {
                    hasStatus = true;
                }
            });
            if (!hasStatus) {
                showBlock = false;
            }
        }
        
        block. style.display = showBlock ? '' : 'none';
    });
    
    const visibleCount = document.querySelectorAll('. history-date-block:not([style*="display: none"])').length;
    document.getElementById('totalRecords').textContent = visibleCount;
}

function resetFilters() {
    document.getElementById('filterDate').value = '';
    document.getElementById('filterStatus').value = 'all';
    
    document.querySelectorAll('. history-date-block').forEach(block => {
        block.style.display = '';
    });
    
    document.getElementById('totalRecords').textContent = 
        document.querySelectorAll('. history-date-block').length;
}

function downloadRecord(date, data) {
    if (!data || !data.AttendanceData) return;
    
    let csvContent = "S.No,Name,Status,Submitted Time\n";
    data.AttendanceData.forEach((record, index) => {
        csvContent += `${index + 1},${record.name},${record.status},${record.submitted_time}\n`;
    });
    
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `attendance_${date}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
}

function deleteRecord(date) {
    if (!confirm(`Are you sure you want to delete attendance record for ${date}?`)) {
        return;
    }
    
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch(`/attendance/delete/${date}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('Record deleted successfully! ');
            window.location.reload();
        } else {
            alert(data.message || 'Failed to delete record');
        }
    })
    .catch(err => {
        console.error('Error:', err);
        alert('Server error');
    });
}
</script>

{% endblock %}